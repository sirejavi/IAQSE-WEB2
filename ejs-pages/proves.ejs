<div ng-controller="mainController">
     
        <div class="clearfix">
        <!--combo nivells-->
        <div class="btn-group float-left" title="Nivell de la prova" style="margin-left: 5px; margin-bottom: 5px;">
            <button class="btn btn-secondary dropdown-toggle" type="button" id="nivellCombo" 
                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="fa fa-tags"></i> <span ng-bind="selections.nivell.label"></span></button>
            <div class="dropdown-menu" aria-labelledby="nivellCombo">
                <a class="dropdown-item" ng-click="selectNivell($index)" ng-repeat="item in nivells"><span ng-bind="item.label"></span></a>
            </div>
        </div>
         <!--combo competència-->
         <div class="btn-group float-left" title="Competència" style="margin-left: 5px; margin-bottom: 5px;">
                <button class="btn btn-secondary dropdown-toggle" type="button" id="competenciaCombo" 
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="fa fa-tags"></i> <span ng-bind="selections.competencia.label"></span></button>
                <div class="dropdown-menu" aria-labelledby="competenciaCombo">
                    <a class="dropdown-item" ng-click="selectCompetencia($index)" ng-repeat="item in competencies"><span ng-bind="item.label"></span></a>
                </div>
        </div>
         <!--combo anys -->
         <div class="btn-group float-left" title="Any de la prova" style="margin-left: 5px; margin-bottom: 5px;">
                <button class="btn btn-secondary dropdown-toggle" type="button" id="anyCombo" 
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="fa fa-tags"></i> <span ng-bind="selections.any.label"></span></button>
                <div class="dropdown-menu" aria-labelledby="anyCombo" style="overflow: scroll; max-height: 300px;">
                    <a class="dropdown-item" ng-click="selectAny($index)" ng-repeat="item in anys"><span ng-bind="item.label"></span></a>
                </div>
        </div>
        
    </div> 


    <hr />
    <p ng-if="pubslength==0">No s'han trobat proves</p>
    <p ng-if="pubslength==1">S'ha trobat una prova</p>
    <p ng-if="pubslength>1">S'han trobat <span ng-bind="pubslength"></span> proves</p>
    <hr />

    <div class="list-group">
        <div class="row" ng-repeat="chunk in pubs">
        <div class="col-md-6 list-group-item list-group-item-hover" ng-repeat="pub in chunk">
            <div class="fa-pull-left">
                <i ng-if="pub.destacat" class="fa fa-star"></i>
                <a href="../{{pub.url}}" target="_blank">
                    <img ng-src="../{{pub.img}}" class="publication-img" />
                </a>
            </div>

            <p class="publication-title"><a href="../{{pub.url}}" target="_blank" title="{{pub.url_title}}"><span ng-bind="pub.title"></span></a></p>
            <p ng-bind="pub.description"></p>
            <p class="fa-pull-right publication-date" ng-bind="pub.pubdate"></p>

        </div>
        </div>
    </div>
</div>
<script>
    app.controller("mainController", ["$scope", "$filter", "httpService", function ($scope, $filter, httpService) {
        $scope.pubs = [];
        $scope.pubslength = 0;

        $scope.nivells = [
            {label:"3r EP", value: "3rEP"},
            {label:"6è EP", value: "6eEP"},
            {label:"2n ESO", value: "2nESO"},
            {label:"4t ESO", value: "4tESO"} 
            ];
        $scope.competencies = [
            {label: "Competència Llengua Anglesa", value: "CCLA"},
            {label: "Competència Llengua Castellana", value: "CCLE"},
            {label: "Competència Llengua Catalana", value: "CCLC"},
            {label: "Competència Matemàtica", value: "CMAT"},
            {label: "Competència Ciència i Tecnologia", value: "CCiT"}            
        ];
        // Els anys es determinen en funció del nivell i la competència seleccionades
        $scope.determinaAnys = function() {
            $scope.anys = [];
            // Determina els anys
            for(var i=0, len=provesJSON.length; i<len; i++) {
                var item = provesJSON[i];           
                if(item.any && item.nivell == $scope.selections.nivell.value &&
                   item.tags.indexOf($scope.selections.competencia.value)>=0) {
                    var found = false;
                    var k = 0;
                    var n = $scope.anys.length;
                    while(!found && k < n) {
                        found = $scope.anys[k].value == item.any; 
                        k++;
                    }
                    if(!found) {
                        $scope.anys.push({label: item.any, value: item.any});
                    }
                }
            }
            // ordena
            $scope.anys = $filter("orderBy")($scope.anys, "+label", true);
            $scope.anys.unshift({label: "Tots els anys", value: -1});
            $scope.selectAny(0);
        };

        $scope.selections = {
            nivell: $scope.nivells[0],
            competencia: $scope.competencies[0] 
        };
       
        $scope.selectNivell = function(index) {
            $scope.selections.nivell = $scope.nivells[index];
            $scope.determinaAnys() 
            $scope.search();
        };
        $scope.selectCompetencia = function(index) {
            $scope.selections.competencia = $scope.competencies[index];
            $scope.determinaAnys();
            $scope.search();                        
        };
        $scope.selectAny = function(index) {
            $scope.selections.any = $scope.anys[index];
            $scope.search();
        };

        $scope.search = function () {
            var list = [];
            for(var i=0, len = provesJSON.length; i<len; i++) {
                var item = provesJSON[i];
                if(item.nivell == $scope.selections.nivell.value &&
                   item.tags.indexOf($scope.selections.competencia.value)>=0 &&
                   ( $scope.selections.any.value==-1 || item.any==$scope.selections.any.value )) {
                    list.push(item);
                }

            }
            $scope.pubslength = list.length;
            $scope.pubs = chunker(list, 2);
        };

        $scope.keypress = function (keyEvent) {
            if (keyEvent.which === 13) {
                $scope.search();
            }
        }; 
        
        httpService.loadSchema("proves").then(function(response){
            window.provesJSON = response.data;
            $scope.determinaAnys();
        })
        

    }]);
</script>